<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background-color: #f9fafb;
    }

    .sidebar {
      width: 280px;
      background-color: #1f2937;
      color: white;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    .sidebar h2 {
      margin-top: 0;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }

    .sidebar a.logout-link {
      color: #f87171;
      text-decoration: none;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      display: inline-block;
    }

    .new-conversation-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 1rem;
      transition: background-color 0.2s;
    }

    .new-conversation-btn:hover {
      background-color: #2563eb;
    }

    .sidebar form {
      margin-top: 1rem;
    }

    .sidebar .upload-form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .sidebar input[type="file"] {
      width: 100%;
      margin-bottom: 0.5rem;
      color: #d1d5db;
    }

    .supported-formats {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }

    .sidebar button {
      padding: 8px 12px;
      background-color: #10b981;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .sidebar button:hover {
      background-color: #059669;
    }

    .loading-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #6b7280;
    }
    
    .loading-indicator i {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #3b82f6;
    }

    .manage-vectors-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background-color: #f59e0b;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
      margin: 1rem 0;
      transition: background-color 0.2s;
      text-decoration: none;
      text-align: center;
    }

    .manage-vectors-btn:hover {
      background-color: #d97706;
    }

    .sidebar .history {
      margin-top: 2rem;
      max-height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .sidebar .history h4 {
      position: sticky;
      top: 0;
      background-color: #1f2937;
      margin-top: 0;
      padding: 5px 0;
      z-index: 5;
    }

    .sidebar .history ul {
      margin: 0;
      padding: 0;
      list-style-type: none;
      overflow-y: auto;
      max-height: calc(100vh - 350px);
      scrollbar-width: thin;
    }

    .sidebar .history li {
      font-size: 0.85rem;
      padding: 5px 0;
      border-bottom: 1px solid #374151;
      cursor: pointer;
    }

    .sidebar .history li:hover {
      background-color: #374151;
    }

    .sidebar .history li.active {
      background: #e0c68a;
      color: #2c3e50;
      font-weight: bold;
      border-radius: 5px;
      border-left: 3px solid #bfa14a;
      padding-left: 5px;
    }

    .sidebar .history li.active i {
      color: #2c3e50;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }

    .chat-box {
      flex: 1;
      background: #ffffff;
      border-radius: 8px;
      padding: 1rem;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .message {
      margin-bottom: 1rem;
    }

    .message.user {
      text-align: right;
    }

    .message.user p {
      background: #dcfce7;
      padding: 10px;
      border-radius: 10px;
      display: inline-block;
      max-width: 70%;
      text-align: left;
    }

    .message.assistant p {
      background: #f3f4f6;
      padding: 10px;
      border-radius: 10px;
      display: inline-block;
      max-width: 70%;
    }

    /* Markdown formatting for LLM responses */
    .message.assistant p {
      line-height: 1.6;
    }

    .message.assistant p strong,
    .message.assistant p b {
      font-weight: bold;
      color: #111827;
    }

    /* Section headers with ** ** formatting */
    .message.assistant p strong {
      display: block;
      font-size: 1.1rem;
      margin-top: 14px;
      margin-bottom: 8px;
      color: #1e40af;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 3px;
    }

    /* Bullet points */
    .message.assistant p ul {
      padding-left: 20px;
      margin: 8px 0;
    }

    .message.assistant p li {
      margin-bottom: 4px;
    }

    /* Emphasis/italics */
    .message.assistant p em,
    .message.assistant p i {
      font-style: italic;
      color: #4b5563;
    }

    /* Numbered lists */
    .message.assistant p ol {
      padding-left: 20px;
      margin: 8px 0;
    }

    /* Paragraphs with proper spacing */
    .message.assistant p p {
      margin: 10px 0;
    }

    .input-bar {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      position: relative;
    }

    .input-bar input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .input-bar button {
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background-color: #3b82f6;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.2s;
    }

    .input-bar button:hover {
      background-color: #2563eb;
    }

    .conversation-title {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #4b5563;
      font-size: 1.5rem;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6b7280;
    }
    
    .empty-state svg {
      margin-bottom: 1rem;
      color: #9CA3AF;
    }
    
    .empty-state h3 {
      margin-bottom: 0.5rem;
    }

    .progress-container {
      margin-top: 1rem;
      display: none;
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .progress {
      width: 0%;
      height: 100%;
      background-color: #28a745;
      transition: width 0.3s ease;
      position: absolute;
      top: 0;
      left: 0;
    }

    .progress-text {
      margin-top: 0.5rem;
      text-align: center;
      color: #6c757d;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .progress-percentage {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      font-size: 0.8rem;
      font-weight: bold;
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }

    .title-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title-actions {
      display: flex;
      gap: 5px;
    }

    .edit-title-btn, .delete-conversation-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .edit-title-btn:hover {
      color: #007bff;
      background: rgba(0, 123, 255, 0.1);
    }

    .delete-conversation-btn:hover {
      color: #dc3545;
      background: rgba(220, 53, 69, 0.1);
    }

    #conversation-title {
      margin: 0;
      flex-grow: 1;
    }

    .title-input {
      width: 100%;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1.2em;
      margin-right: 10px;
    }

    .voice-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 12px;
      border-radius: 50%;
      transition: all 0.3s ease;
      position: relative;
    }

    .voice-button:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }

    .voice-button.recording {
      background-color: #ff4444;
      color: white;
      animation: pulse 1.5s infinite;
    }

    .voice-status {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
      opacity: 0;
      transition: opacity 0.3s ease;
      white-space: nowrap;
    }

    .voice-button:hover .voice-status {
      opacity: 1;
    }

    .voice-button.recording .voice-status {
      background: #ff4444;
      opacity: 1;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .search-container {
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    #transcriptionPanel {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 500px;
      max-height: 600px;
      overflow-y: auto;
      z-index: 9999;
      border: 2px solid #3b82f6;
    }

    #transcriptionPanel.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .transcription-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #3b82f6;
    }

    .transcription-header h4 {
      color: #3b82f6;
      font-size: 1.4em;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .recording-indicator {
      display: inline-block;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #ccc;
      margin-left: 10px;
      transition: background 0.3s ease;
    }

    .recording-indicator.active {
      background: #ef4444;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .clear-btn {
      padding: 8px 15px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .clear-btn:hover {
      background: #2563eb;
    }

    .voice-level-indicator {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-top: 20px;
      overflow: hidden;
    }

    .voice-level {
      height: 100%;
      width: 0%;
      background: #2196f3;
      transition: width 0.1s ease;
    }

    .voice-btn {
      background-color: #10b981;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      min-width: 44px;
      min-height: 44px;
    }

    .voice-btn:hover {
      background-color: #059669;
    }

    .voice-btn.recording {
      background-color: #ef4444;
      animation: pulse 1.5s infinite;
    }

    .voice-btn i {
      font-size: 1.2em;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .message.assistant {
        position: relative;
    }

    .speak-btn {
        position: absolute;
        right: 10px;
        top: 10px;
        background: none;
        border: none;
        color: #3b82f6;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.2s;
        opacity: 0.6;
    }

    .speak-btn:hover {
        opacity: 1;
        background: rgba(59, 130, 246, 0.1);
    }

    .speak-btn.speaking {
        color: #ef4444;
        animation: pulse 1.5s infinite;
    }

    .speech-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
    }

    .speech-controls.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .speech-control-btn {
        background: none;
        border: none;
        color: #3b82f6;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }

    .speech-control-btn:hover {
        background: rgba(59, 130, 246, 0.1);
    }

    .speech-control-btn.stop {
        color: #ef4444;
    }

    .speech-control-btn.stop:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    .speech-control-btn.speaking {
        animation: pulse 1.5s infinite;
    }

    .speech-control-btn i {
        font-size: 1.2em;
    }

    .speech-control-btn .shortcut {
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.7em;
        color: #6b7280;
        white-space: nowrap;
    }

    /* Transcription window styles */
    .transcription-window {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .transcription-header {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close-transcription {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }

    .transcription-content {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    #final-transcript {
      margin-bottom: 10px;
      color: #333;
    }

    #interim-transcript {
      color: #666;
      font-style: italic;
    }

    .interim {
      color: #666;
      font-style: italic;
    }

    /* Transcription panel styles */
    .transcription-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin: 4px 0 0 0;
      padding: 3px 8px;
      max-height: 40px;
      min-height: 20px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.2;
    }

    .transcription-content {
      font-size: 12px;
      line-height: 1.2;
    }

    .transcription-content .final {
      color: #333;
      margin-bottom: 2px;
    }

    .transcription-content .interim {
      color: #888;
      font-style: italic;
    }

    .speak-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 5px;
      margin-left: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .speak-btn:hover {
      color: #3b82f6;
      background-color: rgba(59, 130, 246, 0.1);
    }

    .speak-btn.speaking {
      color: #3b82f6;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }

    /* Message container to hold text and button */
    .message-content {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .message.user .message-content {
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Welcome, {{ username }}</h2>
    <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>

    <button id="new-conversation-btn" onclick="startNewConversation()" class="new-conversation-btn">
      <i class="fas fa-plus"></i>
      New Conversation
    </button>

    <form method="POST" enctype="multipart/form-data" class="upload-form" id="upload-form">
      <h3><i class="fas fa-upload"></i> Upload Files</h3>
      <div class="supported-formats">
        Supported formats: PDF, DOCX
      </div>
      <input type="file" name="file" multiple accept=".pdf,.docx" />
      <button type="submit"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
      <div class="progress-container" id="progress-container">
        <div class="progress-bar">
          <div class="progress" id="progress-bar"></div>
          <div class="progress-percentage" id="progress-percentage">0%</div>
        </div>
        <div class="progress-text" id="progress-text">Processing...</div>
      </div>
    </form>

    {% if uploaded_file %}
      <div class="uploaded-files">
        <i class="fas fa-file-alt"></i> {{ uploaded_file }}
        {% if upload_time %}
          <div class="upload-time">
            <i class="far fa-clock"></i> {{ upload_time }}
          </div>
        {% endif %}
      </div>
    {% endif %}

    <a href="{{ url_for('manage_vectors') }}" class="manage-vectors-btn">
      <i class="fas fa-database"></i> Manage Document Data
    </a>

    <div class="history">
      <h4><i class="fas fa-history"></i> Conversation History</h4>
      <ul style="list-style-type: none; padding-left: 0;">
        {% for c in all_user_conversations %}
          <li id="conversation-item-{{ c._id }}" 
              {% if session.conversation_id == c._id|string %}class="active"{% endif %}
              style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #374151; padding: 5px 0;">
            <span style="flex: 1; cursor: pointer;" onclick="showHistory('{{ c._id }}')">
              <i class="far fa-comment"></i> <b id="sidebar-title-{{ c._id }}">{{ c.title }}</b>
            </span>
            <span style="display: flex; gap: 4px;">
              <button class="edit-title-btn"
                      title="Edit Title"
                      data-conversation-id="{{ c._id }}"
                      data-conversation-title="{{ c.title|e }}"
                      onclick="event.stopPropagation(); editSidebarTitleFromData(this);">
                <i class="fas fa-edit"></i>
              </button>
              <button class="delete-conversation-btn"
                      title="Delete Conversation"
                      data-conversation-id="{{ c._id }}"
                      onclick="event.stopPropagation(); deleteSidebarConversationFromData(this);">
                <i class="fas fa-trash"></i>
              </button>
            </span>
          </li>
        {% endfor %}
        {% if all_user_conversations|length == 0 %}
          <li style="font-style: italic; color: #9CA3AF;"><i class="far fa-comment-dots"></i> No conversations yet</li>
        {% endif %}
      </ul>
    </div>
  </div>

  <div class="main">
    <div class="chat-container">
      <div class="chat-header">
        <div class="title-container">
          <h2 id="conversation-title">{{ conversation_title }}</h2>
          <div class="title-actions">
            <button class="edit-title-btn" onclick="editTitle()">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-conversation-btn" onclick="deleteConversation()">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-box" id="chat-box">
      {% if conversations and conversations|length > 0 %}
        {% for c in conversations %}
          <div class="message {{ c.role }}">
            <div class="message-content">
              <p>{{ c.message }}</p>
              {% if c.role == 'assistant' %}
                <button class="speak-btn" onclick="speakText('{{ c.message|replace("'", "\\'")|replace("\n", " ") }}')">
                  <i class="fas fa-volume-up"></i>
                </button>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="fas fa-comments fa-3x"></i>
          <h3>Start a new conversation</h3>
          <p>Upload a document or ask a question to get started</p>
        </div>
      {% endif %}
    </div>

    <div class="input-area">
      <form id="query-form" class="input-bar">
        <input id="query-input" name="query" placeholder="Ask something about your documents..." autofocus />
        <button type="button" id="voiceButton" class="voice-btn" style="margin-right: 4px;">
          <i class="fas fa-microphone"></i>
        </button>
        <button type="submit" id="query-submit-btn">
          <i class="fas fa-paper-plane"></i> Ask
        </button>
      </form>
    </div>
  </div>

  <div class="speech-controls" id="speechControls">
    <button class="speech-control-btn stop" id="stopSpeechBtn" title="Stop Speech (Esc)">
        <i class="fas fa-stop"></i>
        <span class="shortcut">Esc</span>
    </button>
  </div>

  <div class="chat-container">
    <div class="chat-messages" id="chat-messages">
      <!-- Messages will be added here -->
    </div>
    
    <!-- Add transcription panel -->
    <div class="transcription-panel" id="transcription-panel" style="display: none;">
      <div class="transcription-content">
        <p class="final" id="final-transcript"></p>
        <p class="interim" id="interim-transcript"></p>
      </div>
    </div>
  </div>

  <div id="transcriptionBox" style="display:none; position:fixed; bottom:100px; right:30px; background:#fff; border:1px solid #3b82f6; border-radius:8px; box-shadow:0 2px 10px rgba(59,130,246,0.15); padding:14px 18px; z-index:2000; min-width:220px; max-width:350px;">
    <div style="font-size:13px; color:#3b82f6; font-weight:600; margin-bottom:6px;">Transcribing...</div>
    <div id="transcriptionFinal" style="font-size:15px; color:#222; margin-bottom:2px;"></div>
    <div id="transcriptionInterim" style="font-size:13px; color:#888; font-style:italic;"></div>
  </div>

  <script>
    function scrollToBottom() {
      const chat = document.getElementById('chat-box');
      setTimeout(() => chat.scrollTop = chat.scrollHeight, 100);
    }

    window.onload = function() {
      scrollToBottom();
      
      // Initialize the session storage with the current conversation ID if available
      const conversationId = "{{ session.conversation_id }}";
      if (conversationId) {
        sessionStorage.setItem('currentConversationId', conversationId);
        
        // Highlight the active conversation in the sidebar
        const activeConversation = document.getElementById('conversation-item-' + conversationId);
        if (activeConversation) {
          activeConversation.classList.add('active');
        }
      }
    };

    // Keep the original startNewConversation function
    function startNewConversation() {
      // Get current conversation ID
      const currentConversationId = sessionStorage.getItem('currentConversationId');
      console.log("startNewConversation called, current ID:", currentConversationId);
      
      // Check if there are any messages in the current chat
      const chatBox = document.getElementById("chat-box");
      const hasMessages = chatBox.querySelectorAll('.message').length > 0;
      const hasEmptyState = chatBox.querySelector('.empty-state') !== null;
      
      console.log("Current chat state: hasMessages =", hasMessages, "hasEmptyState =", hasEmptyState);
      
      // If there's a current conversation with no messages, just clear the UI without making a server call
      if (currentConversationId && !hasMessages && hasEmptyState) {
        console.log("Using existing empty conversation, just resetting UI");
        // If we already have an empty conversation, just make sure UI is reset properly
        document.getElementById('conversation-title').textContent = 'New Conversation';
        
        // Set up empty state in chat box
        chatBox.innerHTML = '';
        const emptyState = document.createElement("div");
        emptyState.className = "empty-state";
        emptyState.innerHTML = `
          <i class="fas fa-comments fa-3x"></i>
          <h3>Start a new conversation</h3>
          <p>Upload a document or ask a question to get started</p>
        `;
        chatBox.appendChild(emptyState);
        
        return;
      }
      
      // Create a new conversation in the database
      fetch('/new_conversation_id', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to create new conversation');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          console.log("Created new conversation with ID:", data.conversation_id);
          
          // Update the session storage with the new conversation ID
          sessionStorage.setItem('currentConversationId', data.conversation_id);
          
          // Set up empty state in chat box
          chatBox.innerHTML = '';
          const emptyState = document.createElement("div");
          emptyState.className = "empty-state";
          emptyState.innerHTML = `
            <i class="fas fa-comments fa-3x"></i>
            <h3>Start a new conversation</h3>
            <p>Upload a document or ask a question to get started</p>
          `;
          chatBox.appendChild(emptyState);
          
          // Reset the conversation title
          document.getElementById('conversation-title').textContent = 'New Conversation';
          
          // Remove active class from all conversations in the sidebar
          const allConversations = document.querySelectorAll('.sidebar .history li');
          allConversations.forEach(item => {
            item.classList.remove('active');
          });
          
          console.log("New conversation UI setup complete, ready for user input");
        } else {
          console.error("Failed to create new conversation:", data);
        }
      })
      .catch(error => {
        console.error("Error creating new conversation:", error);
      });
    }

    // Handle file upload progress
    document.getElementById('upload-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const progressPercentage = document.getElementById('progress-percentage');
      
      // Check if there are files to upload
      const files = this.querySelector('input[type="file"]').files;
      if (files.length === 0) {
        alert("Please select at least one file to upload.");
        return;
      }
      
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressPercentage.textContent = '0%';
      progressText.textContent = 'Processing...';
      
      const formData = new FormData(this);
      const fileNames = Array.from(files).map(file => file.name).join(', ');
      
      // Upload files and track progress
      fetch('/upload_progress', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            if (data.error === "Duplicate files detected") {
              throw new Error(`Duplicate files detected: ${data.duplicates.join(', ')}`);
            }
            throw new Error(data.error || 'Upload failed');
          });
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        function readStream() {
          return reader.read().then(({done, value}) => {
            if (done) {
              progressText.innerHTML = `<i class="fas fa-check-circle"></i> Upload complete!<br>Files: ${fileNames}`;
              progressBar.style.backgroundColor = '#28a745';
              setTimeout(() => window.location.reload(), 2000);
              return;
            }
            
            const text = decoder.decode(value);
            const progress = parseFloat(text.split('data: ')[1]);
            
            if (isNaN(progress)) {
              throw new Error(text);
            }
            
            progressBar.style.width = progress + '%';
            progressPercentage.textContent = progress.toFixed(1) + '%';
            
            if (progress >= 100) {
              progressText.innerHTML = `<i class="fas fa-check-circle"></i> Upload complete!<br>Files: ${fileNames}`;
              progressBar.style.backgroundColor = '#28a745';
              setTimeout(() => window.location.reload(), 2000);
            } else {
              return readStream();
            }
          });
        }
        
        return readStream();
      })
      .catch(error => {
        console.error('Error:', error);
        progressText.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message}`;
        progressBar.style.backgroundColor = '#dc3545';
        progressPercentage.textContent = 'Error';
      });
    });

    function editTitle() {
      const titleElement = document.getElementById('conversation-title');
      const currentTitle = titleElement.textContent;
      
      // Create input field
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentTitle;
      input.className = 'title-input';
      
      // Replace title with input
      titleElement.style.display = 'none';
      titleElement.parentNode.insertBefore(input, titleElement);
      input.focus();
      
      // Handle input events
      input.addEventListener('blur', function() {
        saveTitle(input.value);
      });
      
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          saveTitle(input.value);
        }
      });
    }

    function saveTitle(newTitle) {
      const titleElement = document.getElementById('conversation-title');
      const input = document.querySelector('.title-input');
      
      if (newTitle.trim()) {
        // Update title in database
        fetch('/update_title', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title: newTitle.trim()
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            titleElement.textContent = newTitle.trim();
          } else {
            alert('Failed to update title');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to update title');
        });
      }
      
      // Restore title element
      titleElement.style.display = 'block';
      if (input) {
        input.remove();
      }
    }

    function deleteConversation() {
      if (confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
        fetch('/delete_conversation', {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = '/';
          } else {
            alert('Failed to delete conversation');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to delete conversation');
        });
      }
    }

    function editSidebarTitleFromData(btn) {
      const conversationId = btn.getAttribute('data-conversation-id');
      const currentTitle = btn.getAttribute('data-conversation-title');
      editSidebarTitle(conversationId, currentTitle);
    }

    function deleteSidebarConversationFromData(btn) {
      const conversationId = btn.getAttribute('data-conversation-id');
      deleteSidebarConversation(conversationId);
    }

    function editSidebarTitle(conversationId, currentTitle) {
      const titleElem = document.getElementById('sidebar-title-' + conversationId);
      if (!titleElem) return;

      // Create input field
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentTitle;
      input.className = 'title-input';
      input.style.width = '80%';

      // Replace title with input
      titleElem.style.display = 'none';
      titleElem.parentNode.insertBefore(input, titleElem);

      input.focus();

      input.addEventListener('blur', function() {
        saveSidebarTitle(conversationId, input.value);
      });

      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          saveSidebarTitle(conversationId, input.value);
        }
      });
    }

    function saveSidebarTitle(conversationId, newTitle) {
      const titleElem = document.getElementById('sidebar-title-' + conversationId);
      const input = titleElem ? titleElem.parentNode.querySelector('.title-input') : null;

      if (newTitle.trim()) {
        fetch('/update_title', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: newTitle.trim(),
            conversation_id: conversationId
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            titleElem.textContent = newTitle.trim();
          } else {
            alert('Failed to update title');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to update title');
        });
      }

      if (titleElem) titleElem.style.display = 'inline';
      if (input) input.remove();
    }

    function deleteSidebarConversation(conversationId) {
      if (confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
        fetch('/delete_conversation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conversation_id: conversationId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert('Failed to delete conversation');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to delete conversation');
        });
      }
    }

    // Speech recognition setup
    let recognition = null;
    let isRecording = false;
    let finalTranscript = '';
    let interimTranscript = '';

    // Initialize speech recognition
    function initSpeechRecognition() {
        console.log('[DEBUG] Initializing speech recognition');
        try {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.error('[ERROR] Speech recognition not supported in this browser');
                alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
                return false;
            }
            
            console.log('[DEBUG] Creating SpeechRecognition instance');
            recognition = new SpeechRecognition();
            
            console.log('[DEBUG] Configuring SpeechRecognition');
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                console.log('[DEBUG] recognition.onstart fired');
            };
            recognition.onaudiostart = function() {
                console.log('[DEBUG] recognition.onaudiostart fired');
            };
            recognition.onsoundstart = function() {
                console.log('[DEBUG] recognition.onsoundstart fired');
            };
            recognition.onspeechstart = function() {
                console.log('[DEBUG] recognition.onspeechstart fired');
            };
            recognition.onspeechend = function() {
                console.log('[DEBUG] recognition.onspeechend fired');
            };
            recognition.onsoundend = function() {
                console.log('[DEBUG] recognition.onsoundend fired');
            };
            recognition.onaudioend = function() {
                console.log('[DEBUG] recognition.onaudioend fired');
            };

            // Handle speech recognition results
            recognition.onresult = function(event) {
                console.log('[DEBUG] recognition.onresult fired');
                interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                        console.log('[DEBUG] Final transcript:', finalTranscript);
                    } else {
                        interimTranscript += transcript;
                        console.log('[DEBUG] Interim transcript:', interimTranscript);
                    }
                }
                updateTranscriptionDisplay();
            };

            // Handle errors
            recognition.onerror = function(event) {
                console.error('[ERROR] recognition.onerror:', event.error);
                isRecording = false;
                updateRecordingUI(false);
                alert('Speech recognition error: ' + event.error);
                switch(event.error) {
                    case 'not-allowed':
                        alert('Microphone access was denied. Please allow microphone access and try again.');
                        break;
                    case 'no-speech':
                        alert('No speech was detected. Please try speaking again.');
                        break;
                    case 'audio-capture':
                        alert('No microphone was found. Please ensure that a microphone is installed and working.');
                        break;
                    case 'network':
                        alert('Network error occurred. Please check your internet connection and try again.');
                        break;
                    default:
                        alert('Speech recognition error: ' + event.error);
                }
            };

            // Handle when recognition ends
            recognition.onend = function() {
                console.log('[DEBUG] recognition.onend fired');
                isRecording = false;
                updateRecordingUI(false);
                
                // If we have transcribed text, submit the form
                if (finalTranscript.trim()) {
                    console.log('[DEBUG] Auto-submitting form with transcribed text');
                    const queryForm = document.getElementById('query-form');
                    if (queryForm) {
                        queryForm.requestSubmit();
                    }
                }
            };

            console.log('[DEBUG] Speech recognition initialized successfully');
            return true;
        } catch (error) {
            console.error('[ERROR] Failed to initialize speech recognition:', error);
            alert('Failed to initialize speech recognition. Please make sure you are using a supported browser (Chrome, Edge, or Safari) and have granted microphone permissions.');
            return false;
        }
    }

    // Update the input field with transcribed text
    function updateTranscriptionDisplay() {
        console.log('[DEBUG] Updating transcription display');
        const queryInput = document.getElementById('query-input');
        const box = document.getElementById('transcriptionBox');
        const finalDiv = document.getElementById('transcriptionFinal');
        const interimDiv = document.getElementById('transcriptionInterim');
        if (isRecording) {
            if (box) box.style.display = 'block';
            if (finalDiv) finalDiv.textContent = finalTranscript.trim();
            if (interimDiv) interimDiv.textContent = interimTranscript.trim();
            if (queryInput) {
                if (interimTranscript) {
                    queryInput.value = (finalTranscript + ' ' + interimTranscript).trim();
                } else {
                    queryInput.value = finalTranscript.trim();
                }
                console.log('[DEBUG] Updated input value:', queryInput.value);
            }
        } else {
            if (box) box.style.display = 'none';
            if (finalDiv) finalDiv.textContent = '';
            if (interimDiv) interimDiv.textContent = '';
            if (queryInput) {
                queryInput.value = finalTranscript.trim();
                console.log('[DEBUG] Final input value:', queryInput.value);
            }
        }
    }

    function toggleRecording() {
        console.log('[DEBUG] toggleRecording called. isRecording:', isRecording, 'recognition:', recognition);
        if (!recognition) {
            console.log('[DEBUG] Creating new speech recognition instance');
            if (!initSpeechRecognition()) {
                console.error('[ERROR] Failed to initialize speech recognition');
                return;
            }
        }
        
        if (isRecording) {
            console.log('[DEBUG] Stopping recognition');
            try {
                recognition.stop();
                console.log('[DEBUG] recognition.stop() called');
            } catch (error) {
                console.error('[ERROR] Error stopping recognition:', error);
                alert('Error stopping recognition: ' + error.message);
            }
        } else {
            finalTranscript = '';
            interimTranscript = '';
            console.log('[DEBUG] Starting recognition');
            try {
                recognition.start();
                console.log('[DEBUG] recognition.start() called');
                isRecording = true;
                updateRecordingUI(true);
            } catch (error) {
                console.error('[ERROR] Failed to start recognition:', error);
                alert('Failed to start voice recognition. ' + error.message + '\nPlease make sure you have granted microphone permissions and are using a supported browser (Chrome, Edge, or Safari).');
            }
        }
    }

    // Update UI based on recording state
    function updateRecordingUI(recording) {
        console.log('[DEBUG] Updating recording UI:', recording);
        const voiceButton = document.getElementById('voiceButton');
        if (voiceButton) {
            if (recording) {
                voiceButton.classList.add('recording');
                voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
            } else {
                voiceButton.classList.remove('recording');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        } else {
            console.error('[ERROR] Voice button not found');
        }
    }

    // Initialize speech recognition when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[DEBUG] DOM Content Loaded');
        initSpeechRecognition();
        
        // Use event delegation for the voice button
        document.addEventListener('click', function(e) {
            const voiceButton = document.getElementById('voiceButton');
            if (voiceButton && e.target === voiceButton) {
                console.log('[DEBUG] Voice button CLICKED! (delegated)');
                e.preventDefault();
                toggleRecording();
            }
        });
    });

    // Add speech synthesis functionality
    let currentSpeech = null;

    function speakText(text) {
      if (currentSpeech) {
        speechSynthesis.cancel();
      }
      
      const utterance = new SpeechSynthesisUtterance(text);
      currentSpeech = utterance;
      
      // Find and update the speaking button
      const speakBtns = document.querySelectorAll('.speak-btn');
      speakBtns.forEach(btn => btn.classList.remove('speaking'));
      const clickedBtn = event.currentTarget;
      clickedBtn.classList.add('speaking');
      
      utterance.onend = () => {
        currentSpeech = null;
        clickedBtn.classList.remove('speaking');
      };
      
      speechSynthesis.speak(utterance);
    }

    // Stop speaking when switching conversations or starting new ones
    function stopSpeaking() {
      if (currentSpeech) {
        speechSynthesis.cancel();
        currentSpeech = null;
        const speakBtns = document.querySelectorAll('.speak-btn');
        speakBtns.forEach(btn => btn.classList.remove('speaking'));
      }
    }

    // Add keyboard shortcut for stopping speech
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        stopSpeaking();
      }
    });

    // Modify the message creation to include speaker button
    function createMessageElement(role, message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      const messageP = document.createElement('p');
      if (role === 'assistant') {
        messageP.innerHTML = renderMarkdown(message);
      } else {
        messageP.textContent = message;
      }
      
      messageContent.appendChild(messageP);
      
      if (role === 'assistant') {
        const speakBtn = document.createElement('button');
        speakBtn.className = 'speak-btn';
        speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        speakBtn.onclick = function() {
          speakText(message.replace(/'/g, "\\'").replace(/\n/g, " "));
        };
        messageContent.appendChild(speakBtn);
      }
      
      messageDiv.appendChild(messageContent);
      return messageDiv;
    }

    // Update the query form submission to use the new message creation
    document.getElementById('query-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const queryInput = document.getElementById('query-input');
      const queryText = queryInput.value.trim();
      const submitButton = document.getElementById('query-submit-btn');
      
      if (!queryText) return;
      
      // Add user message to the chat immediately
      const chatBox = document.getElementById('chat-box');
      const emptyState = chatBox.querySelector('.empty-state');
      if (emptyState) {
        chatBox.innerHTML = '';
      }
      
      const userMessageDiv = createMessageElement('user', queryText);
      chatBox.appendChild(userMessageDiv);
      scrollToBottom();
      
      // Disable input and button while processing
      queryInput.disabled = true;
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      
      // Send the query to the server
      fetch('/query', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `query=${encodeURIComponent(queryText)}${sessionStorage.getItem('currentConversationId') ? `&conversation_id=${sessionStorage.getItem('currentConversationId')}` : ''}`
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'Network response was not ok');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        // Add the assistant's response to the chat
        const assistantMessageDiv = createMessageElement('assistant', data.answer);
        chatBox.appendChild(assistantMessageDiv);
        scrollToBottom();
        
        // Update the session storage with the conversation ID
        if (data.conversation_id) {
          sessionStorage.setItem('currentConversationId', data.conversation_id);
        }
        
        // Update conversation title if it has changed
        if (data.title) {
          document.getElementById('conversation-title').textContent = data.title;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        const errorMessageDiv = createMessageElement('assistant', `Error: ${error.message}`);
        errorMessageDiv.querySelector('.message-content').classList.add('error');
        chatBox.appendChild(errorMessageDiv);
        scrollToBottom();
      })
      .finally(() => {
        // Re-enable input and button
        queryInput.disabled = false;
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Ask';
        queryInput.value = '';
        queryInput.focus();
      });
    });
  </script>

  <!-- Add Markdown-it for rendering markdown -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@12.0.4/dist/markdown-it.min.js"></script>
  <script>
    // Initialize markdown parser
    const md = window.markdownit({
      html: false,
      linkify: true,
      typographer: true
    });

    // Function to safely render markdown
    function renderMarkdown(text) {
      return md.render(text);
    }

    // Override the add message function to use markdown
    document.addEventListener('DOMContentLoaded', function() {
      // Process any existing messages
      document.querySelectorAll('.message.assistant p').forEach(function(messageEl) {
        const originalText = messageEl.textContent;
        messageEl.innerHTML = renderMarkdown(originalText);
      });

      // Remove the original query form event listener and set a new one
      const queryForm = document.getElementById('query-form');
      // Clone the form element to remove all event listeners
      const newQueryForm = queryForm.cloneNode(true);
      queryForm.parentNode.replaceChild(newQueryForm, queryForm);
      
      // Add our new event listener to the cloned form
      newQueryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const queryInput = document.getElementById('query-input');
        const queryText = queryInput.value.trim();
        const submitButton = document.getElementById('query-submit-btn');
        
        if (!queryText) return;
        
        // Disable input and button while processing
        queryInput.disabled = true;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        // Add user message to the chat immediately
        const chatBox = document.getElementById('chat-box');
        
        // Clear empty state if it exists
        const emptyState = chatBox.querySelector('.empty-state');
        if (emptyState) {
          chatBox.innerHTML = '';
        }
        
        const userMessageDiv = createMessageElement('user', queryText);
        chatBox.appendChild(userMessageDiv);
        scrollToBottom();
        
        // Send the query to the server with default advanced search settings
        fetch('/query', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `query=${encodeURIComponent(queryText)}${sessionStorage.getItem('currentConversationId') ? `&conversation_id=${sessionStorage.getItem('currentConversationId')}` : ''}`
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(data => {
              throw new Error(data.error || 'Network response was not ok');
            });
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            throw new Error(data.error);
          }
          
          console.log("Server response:", data);
          
          // Add the assistant's response to the chat
          const assistantMessageDiv = createMessageElement('assistant', data.answer);
          chatBox.appendChild(assistantMessageDiv);
          scrollToBottom();
          
          // Update the session storage with the conversation ID
          if (data.conversation_id) {
            console.log("Setting conversation ID in sessionStorage:", data.conversation_id);
            sessionStorage.setItem('currentConversationId', data.conversation_id);
          }
          
          // Update conversation title if it has changed
          if (data.title) {
            document.getElementById('conversation-title').textContent = data.title;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          // Add error message to chat
          const errorMessageDiv = createMessageElement('assistant', `Error: ${error.message}`);
          errorMessageDiv.querySelector('.message-content').classList.add('error');
          chatBox.appendChild(errorMessageDiv);
          scrollToBottom();
        })
        .finally(() => {
          // Re-enable input and button
          queryInput.disabled = false;
          submitButton.disabled = false;
          submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Ask';
          queryInput.value = '';
          queryInput.focus();
        });
      });

      // Also replace the showHistory function to properly render markdown
      const originalShowHistory = window.showHistory;
      window.showHistory = function(conversationId) {
        // Store the conversation ID in session storage
        sessionStorage.setItem('currentConversationId', conversationId);
        
        // Remove active class from all conversations
        const allConversations = document.querySelectorAll('.sidebar .history li');
        allConversations.forEach(item => {
          item.classList.remove('active');
        });
        
        // Add active class to selected conversation
        const selectedConversation = document.getElementById('conversation-item-' + conversationId);
        if (selectedConversation) {
          selectedConversation.classList.add('active');
        }
        
        // Show loading indicator
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = '<div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i> Loading conversation...</div>';
        
        fetch(`/conversation/${conversationId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            // Update the conversation title
            let selectedTitle = data.title || 'Selected Conversation';
            document.getElementById('conversation-title').textContent = selectedTitle;
            
            // Clear previous conversation
            chatBox.innerHTML = ''; 
            
            // Add messages to chat box
            if (data.messages && data.messages.length > 0) {
              data.messages.forEach(msg => {
                const div = document.createElement("div");
                div.classList.add("message", msg.role);
                const p = document.createElement("p");
                
                // Apply markdown rendering to assistant messages
                if (msg.role === 'assistant') {
                  p.innerHTML = renderMarkdown(msg.message);
                } else {
                  p.textContent = msg.message;
                }
                
                div.appendChild(p);
                chatBox.appendChild(div);
              });
            } else {
              // Handle empty conversation
              const emptyState = document.createElement("div");
              emptyState.className = "empty-state";
              emptyState.innerHTML = `
                <i class="fas fa-comments fa-3x"></i>
                <h3>Empty Conversation</h3>
                <p>This conversation has no messages yet</p>
              `;
              chatBox.appendChild(emptyState);
            }
            
            scrollToBottom();
          })
          .catch(error => {
            console.error('Error fetching conversation:', error);
            alert('Failed to load conversation history. Please try again.');
          });
      };
    });
  </script>
</body>
</html>